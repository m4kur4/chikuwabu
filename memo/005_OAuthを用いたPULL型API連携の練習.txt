ç´ æ™´ã‚‰ã—ã„ã§ã™ã­ï¼ã€Œè‡ªåˆ†ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’åŒæœŸã™ã‚‹ã€ã¨ã„ã†ã‚´ãƒ¼ãƒ«ã¯ã€ãƒãƒƒãƒé–‹ç™ºã®åŸºç¤ŽãŒã™ã¹ã¦è©°ã¾ã£ã¦ã„ã¾ã™ã€‚

ã¾ãšã¯ã€**GitHub API** ã‚’ä½¿ã„ã€**Laravel Socialite** ã§èªè¨¼ã—ã€**Artisanã‚³ãƒžãƒ³ãƒ‰**ã§ãƒ‡ãƒ¼ã‚¿ã‚’PULLã™ã‚‹å…·ä½“çš„ãªå®Ÿè£…ã®æµã‚Œã‚’è§£èª¬ã—ã¾ã™ã€‚

---

## ðŸ› ï¸ æº–å‚™ï¼šGitHubã§ã®ã‚¢ãƒ—ãƒªç™»éŒ²

1. [GitHub Developer Settings](https://github.com/settings/developers) ã«ã‚¢ã‚¯ã‚»ã‚¹ã€‚
2. **New OAuth App** ã‚’ä½œæˆã€‚
* **Homepage URL**: `http://localhost:8000`
* **Authorization callback URL**: `http://localhost:8000/auth/github/callback`


3. `Client ID` ã¨ `Client Secret` ã‚’ãƒ¡ãƒ¢ã—ã¾ã™ã€‚

---

## 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æº–å‚™

ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã‚’ä¿å­˜ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã€OAuthãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå¿…è¦ã§ã™ã€‚

```bash
# repositoriesãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
php artisan make:migration create_repositories_table

```

**`database/migrations/xxxx_create_repositories_table.php`**

```php
Schema::create('repositories', function (Blueprint $table) {
    $table->id();
    $table->integer('github_id')->unique();
    $table->string('name');
    $table->string('full_name');
    $table->string('html_url');
    $table->timestamps();
});

```

â€»ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜ç”¨ã«ã¯ã€æ—¢å­˜ã® `users` ãƒ†ãƒ¼ãƒ–ãƒ«ã« `github_token` ã¨ `github_refresh_token` ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã™ã‚‹ã®ãŒä¸€ç•ªç°¡å˜ã§ã™ã€‚

---

## 2. Socialiteã§èªè¨¼ã¨ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜

ã¾ãšã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
`composer require laravel/socialite`

**`routes/web.php`** ã«èªè¨¼ç”¨ã®ãƒ«ãƒ¼ãƒˆã‚’æ›¸ãã¾ã™ã€‚

```php
use Laravel\Socialite\Facades\Socialite;
use App\Models\User;

Route::get('/auth/github', function () {
    // offlineã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ãŒå¿…è¦ãªå ´åˆã¯è¨­å®šã‚’è¿½åŠ 
    return Socialite::driver('github')->scopes(['repo'])->redirect();
});

Route::get('/auth/github/callback', function () {
    $githubUser = Socialite::driver('github')->user();

    // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç´ä»˜ã‘ã¦ä¿å­˜
    // $githubUser->token, $githubUser->refreshToken ãªã©
});

```

---

## 3. PULLåž‹ãƒãƒƒãƒï¼ˆArtisanã‚³ãƒžãƒ³ãƒ‰ï¼‰ã®å®Ÿè£…

ã“ã“ãŒæœ¬é¡Œã®ãƒãƒƒãƒå‡¦ç†ã§ã™ã€‚

```bash
php artisan make:command SyncGitHubRepositories

```

**`app/Console/Commands/SyncGitHubRepositories.php`**

```php
namespace App\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\Http;
use App\Models\User;
use App\Models\Repository;

class SyncGitHubRepositories extends Command
{
    protected $signature = 'github:sync-repos {user_id}';
    protected $description = 'GitHubã‹ã‚‰ãƒªãƒã‚¸ãƒˆãƒªä¸€è¦§ã‚’å–å¾—ã—ã¦åŒæœŸã—ã¾ã™';

    public function handle()
    {
        $userId = $this->argument('user_id');
        $user = User::findOrFail($userId);

        $this->info("User: {$user->name} ã®åŒæœŸã‚’é–‹å§‹ã—ã¾ã™...");

        // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
        $response = Http::withToken($user->github_token)
            ->get('https://api.github.com/user/repos');

        if ($response->failed()) {
            $this->error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            return;
        }

        $repos = $response->json();

        foreach ($repos as $repo) {
            // updateOrCreateã§ã€Œã‚ã‚Œã°æ›´æ–°ã€ãªã‘ã‚Œã°ä½œæˆã€ã‚’å®Ÿç¾ï¼ˆPULLåž‹ã®åŸºæœ¬ï¼‰
            Repository::updateOrCreate(
                ['github_id' => $repo['id']],
                [
                    'name' => $repo['name'],
                    'full_name' => $repo['full_name'],
                    'html_url' => $repo['html_url'],
                ]
            );
        }

        $this->info(count($repos) . " å€‹ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’åŒæœŸã—ã¾ã—ãŸï¼");
    }
}

```

---

## 4. ç·´ç¿’ã®ãƒã‚¤ãƒ³ãƒˆï¼ˆã“ã“ãŒè…•ã®è¦‹ã›æ‰€ï¼‰

å®Ÿè£…ã«æ…£ã‚Œã¦ããŸã‚‰ã€ä»¥ä¸‹ã®èª²é¡Œã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

1. **ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯**: ãƒˆãƒ¼ã‚¯ãƒ³ãŒåˆ‡ã‚Œã¦ã„ãŸã‚‰è‡ªå‹•ã§ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒãƒƒãƒå†…ã«è¿½åŠ ã™ã‚‹ã€‚
2. **ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³**: ãƒªãƒã‚¸ãƒˆãƒªãŒ100å€‹ä»¥ä¸Šã‚ã‚‹å ´åˆã€1ãƒšãƒ¼ã‚¸ç›®ã ã‘ã§ãªãå…¨ä»¶å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãƒ«ãƒ¼ãƒ—ã•ã›ã‚‹ã€‚
3. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆRate Limitï¼‰ã¸ã®å¯¾å¿œ**: APIã®å›žæ•°åˆ¶é™ã«é”ã—ãŸã¨ãã«ã€é©åˆ‡ã«å¾…æ©Ÿï¼ˆsleepï¼‰ã—ãŸã‚Šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã—ãŸã‚Šã™ã‚‹ã€‚

---

ã¾ãšã¯ **Socialiteã®è¨­å®šã¨ã€ã‚³ãƒžãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ `php artisan github:sync-repos 1` ã‚’å©ã„ã¦ãƒ‡ãƒ¼ã‚¿ãŒDBã«å…¥ã‚‹ã¾ã§** ã‚’ç›®æŒ‡ã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ

**ã‚‚ã—é€”ä¸­ã§è©°ã¾ã£ãŸã‚‰ã€ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚„ã€Œã©ã“ã®ã‚³ãƒ¼ãƒ‰ãŒè¦‹ãŸã„ã€ãªã©ã€ä½•ã§ã‚‚èžã„ã¦ãã ã•ã„ã­ï¼**


â– å¯¾å¿œ
[x] webã‚³ãƒ³ãƒ†ãƒŠã§æ–°è¦ã«repositorisã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«
 * root@008bc8e0f451:/var/www/html# php artisan make:migration create_repositories_table
[x] ä½œæˆã•ã‚ŒãŸãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã‚’è¨˜è¿°
[x] æ—¢å­˜ã®usersãƒ†ãƒ¼ãƒ–ãƒ«ã«Githubã®ãƒˆãƒ¼ã‚¯ãƒ³æ ¼ç´ç”¨ã‚«ãƒ©ãƒ è¿½åŠ @ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«
 * root@008bc8e0f451:/var/www/html# php artisan make:migration add_github_tokens_to_users_table --table=users
[x] ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
 * php artisan migrate

[ ] DBã«ãƒ­ã‚°ã‚¤ãƒ³
 * m4kur4@DESKTOP-1B3EP9B:~/development/chikuwabu/php_version_8/docker$ docker-compose exec chikuwabu_db bash
 * bash-5.1# mysql -u chikuwabu -p
   >> chikuwabu3939ococ
 > show databases
 > use chikuwabu_db


ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå‰ã®chikuwabu_dbå†…ãƒ†ãƒ¼ãƒ–ãƒ«
mysql> show tables;
  |
  |
  V
+------------------------+
| Tables_in_chikuwabu_db |
+------------------------+
| cache                  |
| cache_locks            |
| failed_jobs            |
| job_batches            |
| jobs                   |
| migrations             |
| password_reset_tokens  |
| sessions               |
| users                  |
+------------------------+
9 rows in set (0.00 sec)
  |
  |å¢—ãˆãŸï¼
  V
mysql> show tables;
+------------------------+
| Tables_in_chikuwabu_db |
+------------------------+
| cache                  |
| cache_locks            |
| failed_jobs            |
| job_batches            |
| jobs                   |
| migrations             |
| password_reset_tokens  |
| repositories           |
| sessions               |
| users                  |
+------------------------+
10 rows in set (0.00 sec)
  |
  |usersã®ä¸­èº«ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€è¿½åŠ ã—ãŸã€Œgithub_**ã€ã®3ã‚«ãƒ©ãƒ ãŒã¡ã‚ƒã‚“ã¨ã„ã‚‹ï¼
  V
mysql> desc users;
+-------------------------+-----------------+------+-----+---------+----------------+
| Field                   | Type            | Null | Key | Default | Extra          |
+-------------------------+-----------------+------+-----+---------+----------------+
| id                      | bigint unsigned | NO   | PRI | NULL    | auto_increment |
| name                    | varchar(255)    | NO   |     | NULL    |                |
| email                   | varchar(255)    | NO   | UNI | NULL    |                |
| email_verified_at       | timestamp       | YES  |     | NULL    |                |
| password                | varchar(255)    | NO   |     | NULL    |                |
| github_token            | text            | YES  |     | NULL    |                |
| github_refresh_token    | text            | YES  |     | NULL    |                |
| github_token_expires_at | timestamp       | YES  |     | NULL    |                |
| remember_token          | varchar(100)    | YES  |     | NULL    |                |
| created_at              | timestamp       | YES  |     | NULL    |                |
| updated_at              | timestamp       | YES  |     | NULL    |                |
+-------------------------+-----------------+------+-----+---------+----------------+
11 rows in set (0.01 sec)
ã€€